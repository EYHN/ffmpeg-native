name: Build Release
on:
  - push
  - pull_request
env:
  releaseTag: ${{ startsWith(github.ref, 'refs/tags/v') && 0 || format('Commit-{0}', github.sha) }}
jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create Release
        id: create-release
        uses: ncipollo/release-action@v1
        with:
          omitBody: true
          prerelease: true
          tag: ${{ env.releaseTag }}
          token: ${{ secrets.GITHUB_TOKEN }}
  build-macos:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build
        run: |
          ./macos.sh
      - name: Upload Release Asset
        id: upload-release-asset-gz
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: targets/*.tar.gz
          artifactContentType: application/gzip
          artifactErrorsFailBuild: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          prerelease: true
          tag: ${{ env.releaseTag }}
          token: ${{ secrets.GITHUB_TOKEN }}